---
description: Supabase database schema, table relationships, and conventions for AITrader
alwaysApply: true
---

# Supabase Database Schema

Schema files live in `supabase/`:

- `supabase/reset.sql` – one-shot wipe script (run first when resetting all data/schema)
- `supabase/schema.sql` – table/view definitions (run first)
- `supabase/rls_policies.sql` – Row Level Security policies (run second)

The daily cron job is at `src/app/api/cron/daily/route.ts` (runs every weekday; AI ratings + portfolio only execute on rebalance day, prices saved daily).
The AI prompt template and JSON schema are at `src/lib/aiPrompt.ts`.

## Versioning

All strategy version configuration lives in a single file: `src/lib/strategyConfig.ts`.

Two independent version axes:
- `APP_VERSION` (semver, e.g. `v1.0.0`) — bump for app-level changes: prompt text, portfolio rules, universe, ranking methodology, etc.
- `MODEL_VERSION` (m-series, e.g. `m2.0`) — bump for AI model changes: provider swap, model upgrade, temperature/token tuning, etc.
- `STRATEGY_CONFIG` contains all version-sensitive parameters: prompt name/version, model provider/name/version, portfolio size, weighting method, rebalance settings, and description. The strategy slug and prompt version string are derived from both versions.
- `GIT_COMMIT_SHA` captures the deploy commit (from `VERCEL_GIT_COMMIT_SHA`) and is stored in `ai_run_batches.git_commit_sha` for traceability.
- The cron job's mismatch guard prevents silent config mutation: if you change config values without bumping the relevant version (which changes the slug), the cron throws an error.

**Important**: When modifying `src/lib/aiPrompt.ts` (prompt template, Zod schema, or rating logic), you MUST bump `APP_VERSION` in `src/lib/strategyConfig.ts`. When changing the AI model, bump `MODEL_VERSION` instead.

Important: if you suggest changes to supabase/schema.sql, you must also suggest an SQL editor function to implement those changes in supabase.

You must also keep this file up to date.

## Tables (5 layers)

**Reference data**: `stocks` (canonical stock registry, `symbol` unique), `ai_prompts` (versioned by name+version), `ai_models` (versioned by provider+name+version).

**NASDAQ-100 membership**: `nasdaq100_snapshots` (one row per distinct membership list, deduped by SHA-256 hash), `nasdaq100_snapshot_stocks` (join table: snapshot ↔ stocks), `nasdaq_100_daily_raw` (raw NASDAQ API data, not FK'd to stocks).

**Strategy/version control**: `trading_strategies` (immutable strategy versions; prompt/model/portfolio settings), `ai_run_batches` (groups AI runs by run_date + strategy_id; includes `git_commit_sha` for traceability to the deploy commit), `ai_analysis_runs` (one row = one stock + one AI output; score -5 to +5, latent_rank 0-1 tie-breaker, bucket buy/hold/sell, linked to batch).

**Portfolio/performance + research**: `strategy_portfolio_holdings` (weekly Top-20 holdings with equal weights), `strategy_rebalance_actions` (enter/exit_rank/exit_index actions), `strategy_performance_weekly` (weekly net/gross return, turnover, transaction cost, equity curve + benchmark equities), `strategy_quintile_returns` (weekly/4-week quintile forward returns), `strategy_cross_sectional_regressions` (weekly alpha/beta/R² on future returns vs rating).

**Frontend-facing**: `nasdaq100_recommendations_current` (latest score/bucket/latent_rank per NASDAQ-100 member, one row per stock), views `nasdaq100_scores_7d_view` (rolling 7-run avg), `nasdaq100_current_members`, `nasdaq100_latest_snapshot`.

**User tables**: `user_profiles` (linked 1:1 to Supabase `auth.users`, includes `is_premium`, auto-created/kept in sync via triggers on `auth.users`, and stores Stripe webhook ordering metadata in `stripe_last_event_id` + `stripe_last_event_created` + `stripe_subscription_status`), `newsletter_subscribers`.

## Key conventions

- All PKs are UUID (`gen_random_uuid()`).
- The cron job uses `createAdminClient()` (service role key), bypassing RLS.
- Frontend reads use anon/authenticated key with RLS policies.
- Weekly strategy rules: rank all 100 weekly, build Top-20 equal-weight, rebalance weekly, apply turnover cost (15 bps), and track benchmark-relative equity curves.
- When modifying the schema, update `supabase/schema.sql`, `supabase/rls_policies.sql`, the cron job, and this rule file.
- When modifying strategy parameters, prompt, or portfolio rules, bump `APP_VERSION` in `src/lib/strategyConfig.ts`. When changing the AI model, bump `MODEL_VERSION` instead.
